<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×’Ö·Ö¼× Ö´Ö¼×™ â€” × ×™×”×•×œ</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg:     #0F0F13;
  --panel:  #17171E;
  --card:   #1E1E28;
  --border: #2A2A38;
  --coral:  #E8714A;
  --sage:   #52A869;
  --amber:  #F2A93B;
  --blue:   #5B9CF6;
  --red:    #E05A5A;
  --text:   #F0EDE8;
  --muted:  #7A7890;
  --font:   'Heebo', sans-serif;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:var(--font); background:var(--bg); color:var(--text); min-height:100vh; }

/* LOGIN */
#login-screen {
  display:flex; align-items:center; justify-content:center;
  min-height:100vh; padding:20px;
}
.login-card {
  background:var(--panel); border:1px solid var(--border);
  border-radius:20px; padding:40px; width:100%; max-width:360px;
  text-align:center;
}
.login-logo { font-size:32px; font-weight:900; color:var(--coral); margin-bottom:6px; }
.login-sub  { font-size:14px; color:var(--muted); margin-bottom:28px; }
.login-input {
  width:100%; padding:14px 16px; background:var(--card);
  border:1.5px solid var(--border); border-radius:10px;
  font-family:var(--font); font-size:15px; color:var(--text);
  outline:none; margin-bottom:12px; direction:ltr; text-align:center;
  letter-spacing:3px;
}
.login-input:focus { border-color:var(--coral); }
.login-btn {
  width:100%; padding:14px; background:var(--coral); color:white;
  border:none; border-radius:10px; font-family:var(--font);
  font-weight:700; font-size:16px; cursor:pointer;
}
.login-error { color:var(--red); font-size:13px; margin-top:8px; display:none; }

/* LAYOUT */
#app { display:none; min-height:100vh; }
.sidebar {
  position:fixed; right:0; top:0; bottom:0; width:220px;
  background:var(--panel); border-left:1px solid var(--border);
  display:flex; flex-direction:column; padding:24px 0; z-index:100;
}
.sidebar-logo {
  font-size:24px; font-weight:900; color:var(--coral);
  padding:0 20px 20px; border-bottom:1px solid var(--border);
  margin-bottom:16px;
}
.sidebar-logo span { font-size:11px; color:var(--muted); display:block; font-weight:400; margin-top:2px; }
.nav-item {
  display:flex; align-items:center; gap:10px;
  padding:11px 20px; font-size:14px; font-weight:500;
  cursor:pointer; border-radius:0; transition:all 0.15s;
  color:var(--muted); border-right:3px solid transparent;
}
.nav-item:hover { color:var(--text); background:rgba(255,255,255,.04); }
.nav-item.active { color:var(--coral); border-right-color:var(--coral); background:rgba(232,113,74,.08); }
.nav-badge {
  margin-right:auto; background:var(--coral); color:white;
  border-radius:10px; padding:2px 7px; font-size:10px; font-weight:700;
}
.main { margin-right:220px; padding:32px; }
.page { display:none; }
.page.active { display:block; }

/* HEADER */
.page-header { margin-bottom:28px; }
.page-title { font-size:26px; font-weight:900; }
.page-sub   { font-size:14px; color:var(--muted); margin-top:4px; }

/* STAT CARDS */
.stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:28px; }
.stat-card {
  background:var(--card); border:1px solid var(--border);
  border-radius:14px; padding:20px; position:relative; overflow:hidden;
}
.stat-card::before {
  content:''; position:absolute; top:0; right:0; left:0; height:3px;
}
.stat-coral::before  { background:var(--coral); }
.stat-sage::before   { background:var(--sage); }
.stat-amber::before  { background:var(--amber); }
.stat-blue::before   { background:var(--blue); }
.stat-val   { font-size:32px; font-weight:900; margin-bottom:4px; }
.stat-label { font-size:12px; color:var(--muted); }

/* TABLE */
.table-card {
  background:var(--card); border:1px solid var(--border);
  border-radius:14px; overflow:hidden; margin-bottom:20px;
}
.table-header {
  padding:16px 20px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
}
.table-title { font-size:15px; font-weight:700; }
.filter-tabs { display:flex; gap:6px; }
.filter-tab {
  padding:5px 12px; border-radius:7px; font-size:12px; font-weight:600;
  cursor:pointer; border:1px solid var(--border); color:var(--muted);
  background:transparent; font-family:var(--font); transition:all .15s;
}
.filter-tab.active { background:var(--coral); border-color:var(--coral); color:white; }
table { width:100%; border-collapse:collapse; }
th {
  text-align:right; padding:11px 16px; font-size:11px; font-weight:700;
  color:var(--muted); letter-spacing:.5px; text-transform:uppercase;
  border-bottom:1px solid var(--border); background:rgba(255,255,255,.02);
}
td {
  padding:13px 16px; font-size:13px; border-bottom:1px solid var(--border);
  vertical-align:middle;
}
tr:last-child td { border-bottom:none; }
tr:hover td { background:rgba(255,255,255,.02); }

/* BADGES */
.badge {
  display:inline-flex; padding:3px 9px; border-radius:6px;
  font-size:11px; font-weight:700;
}
.b-open    { background:rgba(91,156,246,.15);  color:var(--blue); }
.b-matched { background:rgba(82,168,105,.15);  color:var(--sage); }
.b-failed  { background:rgba(224,90,90,.15);   color:var(--red); }
.b-closed  { background:rgba(122,120,144,.15); color:var(--muted); }
.b-pending { background:rgba(242,169,59,.15);  color:var(--amber); }
.b-paid    { background:rgba(82,168,105,.15);  color:var(--sage); }
.b-active  { background:rgba(82,168,105,.15);  color:var(--sage); }
.b-inactive{ background:rgba(224,90,90,.15);   color:var(--red); }

/* BUTTONS */
.btn {
  padding:6px 12px; border-radius:7px; font-size:11px; font-weight:700;
  border:1px solid; cursor:pointer; font-family:var(--font);
  background:transparent; transition:all .15s; white-space:nowrap;
}
.btn-pay      { border-color:#2D6642; color:var(--sage); }
.btn-pay:hover{ background:rgba(82,168,105,.15); }
.btn-cancel   { border-color:#6B1E1E; color:var(--red); }
.btn-cancel:hover { background:rgba(224,90,90,.15); }
.btn-deactivate   { border-color:#7A5010; color:var(--amber); }
.btn-deactivate:hover { background:rgba(242,169,59,.15); }
.btn-activate     { border-color:#1C3A70; color:var(--blue); }
.btn-activate:hover{ background:rgba(91,156,246,.15); }
.btn:disabled { opacity:.4; cursor:not-allowed; }

/* TOAST */
.toast {
  position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(80px);
  background:var(--panel); border:1px solid var(--border); border-radius:12px;
  padding:12px 20px; font-size:14px; font-weight:500; z-index:999;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1); box-shadow:0 8px 24px rgba(0,0,0,.3);
}
.toast.show { transform:translateX(-50%) translateY(0); }
.toast.success { border-color:var(--sage); color:var(--sage); }
.toast.error   { border-color:var(--red);  color:var(--red); }

/* REFRESH */
.refresh-btn {
  padding:7px 14px; background:transparent; border:1px solid var(--border);
  border-radius:8px; color:var(--muted); font-family:var(--font); font-size:12px;
  cursor:pointer; transition:all .15s; display:flex; align-items:center; gap:6px;
}
.refresh-btn:hover { border-color:var(--coral); color:var(--coral); }
.spinning { animation:spin .8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }

/* EMPTY */
.empty-state {
  text-align:center; padding:48px 20px; color:var(--muted); font-size:14px;
}

/* LOG */
.log-entry {
  padding:10px 16px; border-bottom:1px solid var(--border);
  font-size:12px; display:grid;
  grid-template-columns:140px 120px 1fr 120px;
  gap:12px; align-items:center;
}
.log-entry:last-child { border-bottom:none; }
.log-action { padding:2px 7px; border-radius:5px; font-size:10px; font-weight:700; }
.la-matched       { background:rgba(82,168,105,.15); color:var(--sage); }
.la-already_taken { background:rgba(224,90,90,.15); color:var(--red); }
.la-followup_yes  { background:rgba(242,169,59,.15); color:var(--amber); }
.la-followup_no   { background:rgba(122,120,144,.15); color:var(--muted); }
.la-unknown       { background:rgba(91,156,246,.15); color:var(--blue); }

@media (max-width:900px) {
  .sidebar { display:none; }
  .main { margin-right:0; padding:20px; }
  .stats-grid { grid-template-columns:1fr 1fr; }
}
</style>
</head>
<body>

<!-- â•â•â• LOGIN â•â•â• -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">×’Ö·Ö¼× Ö´Ö¼×™</div>
    <div class="login-sub">×¤×× ×œ × ×™×”×•×œ</div>
    <input class="login-input" type="password" id="admin-pass" placeholder="×¡×™×¡××ª ××“××™×Ÿ">
    <button class="login-btn" onclick="login()">×›× ×™×¡×”</button>
    <div class="login-error" id="login-err">×¡×™×¡××” ×©×’×•×™×”</div>
  </div>
</div>

<!-- â•â•â• APP â•â•â• -->
<div id="app">
  <div class="toast" id="toast"></div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-logo">×’Ö·Ö¼× Ö´Ö¼×™ <span>×¤×× ×œ × ×™×”×•×œ</span></div>
    <div class="nav-item active" onclick="showPage('dashboard')" id="nav-dashboard">
      ğŸ“Š ×“×©×‘×•×¨×“
    </div>
    <div class="nav-item" onclick="showPage('requests')" id="nav-requests">
      ğŸ“‹ ×‘×§×©×•×ª
      <span class="nav-badge" id="badge-open">0</span>
    </div>
    <div class="nav-item" onclick="showPage('payments')" id="nav-payments">
      ğŸ’° ×ª×©×œ×•××™×
      <span class="nav-badge" id="badge-payments" style="background:var(--amber)">0</span>
    </div>
    <div class="nav-item" onclick="showPage('workers')" id="nav-workers">
      ğŸ‘©â€ğŸ’¼ ×¢×•×‘×“×•×ª
    </div>
    <div class="nav-item" onclick="showPage('log')" id="nav-log">
      ğŸ“ ×œ×•×’ ×”×•×“×¢×•×ª
    </div>
  </div>

  <!-- Main -->
  <div class="main">

    <!-- â”€â”€â”€ DASHBOARD â”€â”€â”€ -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div class="page-title">×“×©×‘×•×¨×“</div>
        <div class="page-sub" id="last-updated">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
      </div>
      <div class="stats-grid">
        <div class="stat-card stat-coral">
          <div class="stat-val" id="s-open">â€”</div>
          <div class="stat-label">×‘×§×©×•×ª ×¤×ª×•×—×•×ª</div>
        </div>
        <div class="stat-card stat-sage">
          <div class="stat-val" id="s-matched">â€”</div>
          <div class="stat-label">×‘×§×©×•×ª ×©×”×•×ª×××•</div>
        </div>
        <div class="stat-card stat-amber">
          <div class="stat-val" id="s-pending-pay">â€”</div>
          <div class="stat-label">×ª×©×œ×•××™× ×××ª×™× ×™×</div>
        </div>
        <div class="stat-card stat-blue">
          <div class="stat-val" id="s-revenue">â€”</div>
          <div class="stat-label">×”×›× ×¡×” â‚ª</div>
        </div>
      </div>
      <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
        <div class="stat-card">
          <div class="stat-val" id="s-failed">â€”</div>
          <div class="stat-label">×‘×§×©×•×ª ×©× ×›×©×œ×•</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="s-workers">â€”</div>
          <div class="stat-label">×¢×•×‘×“×•×ª ×¤×¢×™×œ×•×ª</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="s-available">â€”</div>
          <div class="stat-label">×–××™× ×•×ª ×”×™×•×</div>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ REQUESTS â”€â”€â”€ -->
    <div class="page" id="page-requests">
      <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div class="page-title">×‘×§×©×•×ª ×©×™×‘×•×¥</div>
          <div class="page-sub">×›×œ ×”×‘×§×©×•×ª ×œ×¤×™ ×¡×˜×˜×•×¡</div>
        </div>
        <button class="refresh-btn" onclick="loadRequests()"><span id="req-spin">â†»</span> ×¨×¢× ×Ÿ</button>
      </div>
      <div class="filter-tabs" style="margin-bottom:16px;">
        <button class="filter-tab active" onclick="filterRequests('all',this)">×”×›×œ</button>
        <button class="filter-tab" onclick="filterRequests('open',this)">×¤×ª×•×—×•×ª</button>
        <button class="filter-tab" onclick="filterRequests('matched',this)">×”×•×ª×××•</button>
        <button class="filter-tab" onclick="filterRequests('failed',this)">× ×›×©×œ×•</button>
        <button class="filter-tab" onclick="filterRequests('closed',this)">×¡×’×•×¨×•×ª</button>
      </div>
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>×’×Ÿ</th><th>×¢×™×¨</th><th>×ª××¨×™×š</th><th>×©×¢×•×ª</th>
              <th>×’×™×œ</th><th>×¢×•×‘×“×•×ª ×©×”×•×–×× ×•</th><th>×¡×˜×˜×•×¡</th><th>×¤×¢×•×œ×•×ª</th>
            </tr>
          </thead>
          <tbody id="requests-tbody">
            <tr><td colspan="8" class="empty-state">×˜×•×¢×Ÿ...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€â”€ PAYMENTS â”€â”€â”€ -->
    <div class="page" id="page-payments">
      <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div class="page-title">×ª×©×œ×•××™× ×××ª×™× ×™×</div>
          <div class="page-sub">×¡××Ÿ "×©×•×œ×" ×œ××—×¨ ×§×‘×œ×ª ×”×ª×©×œ×•×</div>
        </div>
        <button class="refresh-btn" onclick="loadPayments()"><span>â†»</span> ×¨×¢× ×Ÿ</button>
      </div>
      <div class="table-card">
        <table>
          <thead>
            <tr><th>×’×Ÿ</th><th>××™×© ×§×©×¨</th><th>×˜×œ×¤×•×Ÿ</th><th>×¡×›×•×</th><th>× ×•×¦×¨</th><th>×¡×˜×˜×•×¡</th><th>×¤×¢×•×œ×”</th></tr>
          </thead>
          <tbody id="payments-tbody">
            <tr><td colspan="7" class="empty-state">×˜×•×¢×Ÿ...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€â”€ WORKERS â”€â”€â”€ -->
    <div class="page" id="page-workers">
      <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div class="page-title">×¢×•×‘×“×•×ª</div>
          <div class="page-sub">× ×™×”×•×œ ×××œ××•×ª ××§×•×</div>
        </div>
        <button class="refresh-btn" onclick="loadWorkers()"><span>â†»</span> ×¨×¢× ×Ÿ</button>
      </div>
      <div class="table-card">
        <table>
          <thead>
            <tr><th>×©×</th><th>×˜×œ×¤×•×Ÿ</th><th>×¢×™×¨</th><th>× ×™×¡×™×•×Ÿ</th><th>×–××™× ×” ×”×™×•×</th><th>×¡×˜×˜×•×¡</th><th>×¤×¢×•×œ×•×ª</th></tr>
          </thead>
          <tbody id="workers-tbody">
            <tr><td colspan="7" class="empty-state">×˜×•×¢×Ÿ...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€â”€ LOG â”€â”€â”€ -->
    <div class="page" id="page-log">
      <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div class="page-title">×œ×•×’ ×”×•×“×¢×•×ª × ×›× ×¡×•×ª</div>
          <div class="page-sub">×›×œ ×”-replies ×©×”×ª×§×‘×œ×•</div>
        </div>
        <button class="refresh-btn" onclick="loadLog()"><span>â†»</span> ×¨×¢× ×Ÿ</button>
      </div>
      <div class="table-card">
        <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-size:11px;font-weight:700;color:var(--muted);display:grid;grid-template-columns:140px 120px 1fr 120px;gap:12px;">
          <span>×–××Ÿ</span><span>×˜×œ×¤×•×Ÿ</span><span>×”×•×“×¢×”</span><span>×¤×¢×•×œ×”</span>
        </div>
        <div id="log-body">
          <div class="empty-state">×˜×•×¢×Ÿ...</div>
        </div>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_BASE = window.location.hostname === 'localhost'
  ? 'http://localhost:3000/api'
  : '/api';

let adminPass = '';
let currentFilter = 'all';
let allRequests = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function login() {
  const pass = document.getElementById('admin-pass').value;
  try {
    const r = await fetch(`${API_BASE}/admin/dashboard`, {
      headers: { 'Authorization': 'Basic ' + btoa(':' + pass) }
    });
    if (r.status === 401) {
      document.getElementById('login-err').style.display = 'block';
      return;
    }
    adminPass = pass;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadDashboard();
    loadRequests();
    loadPayments();
    loadWorkers();
    loadLog();
  } catch(e) {
    toast('×©×’×™××ª ×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
  }
}

document.getElementById('admin-pass').addEventListener('keydown', e => {
  if (e.key === 'Enter') login();
});

function authHeaders() {
  return { 'Authorization': 'Basic ' + btoa(':' + adminPass), 'Content-Type': 'application/json' };
}

async function api(path, opts = {}) {
  const r = await fetch(`${API_BASE}/admin${path}`, {
    ...opts,
    headers: { ...authHeaders(), ...(opts.headers || {}) }
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
  try {
    const d = await api('/dashboard');
    document.getElementById('s-open').textContent    = d.requests.open || 0;
    document.getElementById('s-matched').textContent = d.requests.matched || 0;
    document.getElementById('s-failed').textContent  = d.requests.failed || 0;
    document.getElementById('s-pending-pay').textContent = d.pendingPayments || 0;
    document.getElementById('s-revenue').textContent = (d.totalRevenue || 0) + 'â‚ª';
    document.getElementById('s-workers').textContent = d.activeWorkers || 0;
    document.getElementById('s-available').textContent = d.availableToday || 0;
    document.getElementById('badge-open').textContent = d.requests.open || 0;
    document.getElementById('badge-payments').textContent = d.pendingPayments || 0;
    document.getElementById('last-updated').textContent = '×¢×•×“×›×Ÿ: ' + new Date().toLocaleTimeString('he-IL');
  } catch(e) { console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REQUESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRequests() {
  const spin = document.getElementById('req-spin');
  spin.classList.add('spinning');
  try {
    allRequests = await api('/requests?limit=100');
    renderRequests(currentFilter);
  } catch(e) {
    document.getElementById('requests-tbody').innerHTML =
      '<tr><td colspan="8" class="empty-state">×©×’×™××” ×‘×˜×¢×™× ×”</td></tr>';
  }
  spin.classList.remove('spinning');
}

function filterRequests(status, btn) {
  currentFilter = status;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderRequests(status);
}

function renderRequests(filter) {
  const data = filter === 'all' ? allRequests : allRequests.filter(r => r.status === filter);
  const tbody = document.getElementById('requests-tbody');

  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">××™×Ÿ ×‘×§×©×•×ª</td></tr>';
    return;
  }

  tbody.innerHTML = data.map(r => {
    const g = r.kindergartens || {};
    const m = r.matches?.[0];
    const workerName = m?.workers?.name || 'â€”';
    return `<tr>
      <td><strong>${g.garden_name || 'â€”'}</strong></td>
      <td>${g.city || 'â€”'}</td>
      <td>${formatDate(r.date)}</td>
      <td>${r.start_time}â€“${r.end_time}</td>
      <td>${r.age_group}</td>
      <td>${r.workers_notified || 0}${m ? ' â†’ ' + workerName : ''}</td>
      <td><span class="badge b-${r.status}">${statusHe(r.status)}</span></td>
      <td>
        ${r.status === 'open' || r.status === 'matched'
          ? `<button class="btn btn-cancel" onclick="cancelRequest('${r.id}')">×‘×™×˜×•×œ</button>`
          : 'â€”'}
      </td>
    </tr>`;
  }).join('');
}

async function cancelRequest(id) {
  if (!confirm('×œ×‘×˜×œ ×‘×§×©×” ×–×•?')) return;
  try {
    await api(`/requests/${id}/cancel`, { method:'PATCH' });
    toast('×”×‘×§×©×” ×‘×•×˜×œ×”', 'success');
    loadRequests(); loadDashboard();
  } catch(e) { toast('×©×’×™××”', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPayments() {
  try {
    const data = await api('/payments');
    const tbody = document.getElementById('payments-tbody');
    if (!data.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state">××™×Ÿ ×ª×©×œ×•××™× ×××ª×™× ×™× ğŸ‰</td></tr>';
      return;
    }
    tbody.innerHTML = data.map(p => {
      const g = p.requests?.kindergartens || {};
      return `<tr>
        <td><strong>${g.garden_name || 'â€”'}</strong></td>
        <td>${g.contact_name || 'â€”'}</td>
        <td>${g.phone || 'â€”'}</td>
        <td><strong>${p.amount}â‚ª</strong></td>
        <td>${formatDateTime(p.created_at)}</td>
        <td><span class="badge b-${p.status}">${p.status === 'pending' ? '×××ª×™×Ÿ' : '×©×•×œ×'}</span></td>
        <td>
          <button class="btn btn-pay" onclick="markPaid('${p.id}', this)">âœ“ ×©×•×œ×</button>
        </td>
      </tr>`;
    }).join('');
  } catch(e) { console.error(e); }
}

async function markPaid(id, btn) {
  if (!confirm('×œ×¡××Ÿ ×ª×©×œ×•× ×–×” ×›×©×•×œ×?')) return;
  btn.disabled = true;
  try {
    await api(`/payments/${id}/mark-paid`, { method:'PATCH', body: JSON.stringify({ paymentMethod: 'manual' }) });
    toast('âœ“ ×ª×©×œ×•× ×¡×•××Ÿ ×›×©×•×œ×!', 'success');
    loadPayments(); loadDashboard();
  } catch(e) { toast('×©×’×™××”', 'error'); btn.disabled = false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORKERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadWorkers() {
  try {
    const data = await api('/workers');
    const tbody = document.getElementById('workers-tbody');
    if (!data.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state">××™×Ÿ ×¢×•×‘×“×•×ª ×¨×©×•××•×ª</td></tr>';
      return;
    }
    tbody.innerHTML = data.map(w => `<tr>
      <td><strong>${w.name}</strong></td>
      <td>${w.phone}</td>
      <td>${w.city}${w.area ? ' Â· ' + w.area : ''}</td>
      <td>${expHe(w.experience)}</td>
      <td>${w.is_available_today ? 'âœ…' : 'âŒ'}</td>
      <td><span class="badge ${w.is_active ? 'b-active' : 'b-inactive'}">${w.is_active ? '×¤×¢×™×œ×”' : '××•×©×‘×ª×ª'}</span></td>
      <td>
        ${w.is_active
          ? `<button class="btn btn-deactivate" onclick="deactivateWorker('${w.id}',this)">×”×©×‘×ª</button>`
          : `<button class="btn btn-activate"   onclick="activateWorker('${w.id}',this)">×”×¤×¢×œ</button>`
        }
      </td>
    </tr>`).join('');
  } catch(e) { console.error(e); }
}

async function deactivateWorker(id, btn) {
  btn.disabled = true;
  try {
    await api(`/workers/${id}/deactivate`, { method:'PATCH' });
    toast('×¢×•×‘×“×ª ×”×•×©×‘×ª×”', 'success');
    loadWorkers();
  } catch(e) { toast('×©×’×™××”', 'error'); btn.disabled = false; }
}

async function activateWorker(id, btn) {
  btn.disabled = true;
  try {
    await api(`/workers/${id}/activate`, { method:'PATCH' });
    toast('×¢×•×‘×“×ª ×”×•×¤×¢×œ×”', 'success');
    loadWorkers();
  } catch(e) { toast('×©×’×™××”', 'error'); btn.disabled = false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadLog() {
  try {
    const data = await api('/inbound-log');
    const body = document.getElementById('log-body');
    if (!data.length) { body.innerHTML = '<div class="empty-state">××™×Ÿ ×”×•×“×¢×•×ª ×¢×“×™×™×Ÿ</div>'; return; }
    body.innerHTML = data.map(l => {
      const action = l.action_taken || 'unknown';
      const cls = 'la-' + action.split('_').slice(0,2).join('_');
      return `<div class="log-entry">
        <span style="color:var(--muted);font-size:11px;">${formatDateTime(l.received_at)}</span>
        <span style="font-size:12px;">${l.from_phone}</span>
        <span style="color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${l.message_body?.slice(0,80) || 'â€”'}</span>
        <span class="log-action ${cls}">${action}</span>
      </div>`;
    }).join('');
  } catch(e) { console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatDate(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleDateString('he-IL');
}
function formatDateTime(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleString('he-IL', { dateStyle:'short', timeStyle:'short' });
}
function statusHe(s) {
  return { open:'×¤×ª×•×—×”', matched:'×”×•×ª×××”', failed:'× ×›×©×œ×”', closed:'×¡×’×•×¨×”' }[s] || s;
}
function expHe(e) {
  return { '0-1':'< ×©× ×”', '1-3':'1â€“3 ×©× ×™×', '3+':'3+ ×©× ×™×' }[e] || e;
}
function toast(msg, type='success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast show ${type}`;
  setTimeout(() => el.classList.remove('show'), 3000);
}

// Auto-refresh every 30 seconds
setInterval(() => {
  loadDashboard();
  if (document.getElementById('page-requests').classList.contains('active')) loadRequests();
  if (document.getElementById('page-payments').classList.contains('active')) loadPayments();
}, 30000);
</script>
</body>
</html>
